@model HostelMealManagement.Application.ViewModel.MealBazarVm

@{
    ViewData["Title"] = Model.Id > 0 ? "Edit Meal Bazar" : "Create Meal Bazar";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* ---- Page Title + Underline ---- */
    .page-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .page-underline {
        width: 100%;
        height: 1px;
        background: #ccc;
        margin-bottom: 25px;
    }

    /* ---- Form Wrapper ---- */
    .form-wrapper {
        width: 100%;
        background: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        margin-bottom: 40px;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 6px;
    }

    .form-control {
        padding: 12px 14px !important;
        border-radius: 10px !important;
        font-size: 16px !important;
    }

    h4.section-heading {
        margin-top: 35px;
        margin-bottom: 15px;
        font-size: 22px;
        font-weight: 700;
    }

    /* ---- Table ---- */
    table th,
    table td {
        vertical-align: middle;
    }

    #itemsTable input {
        border-radius: 8px !important;
    }

    /* ---- REMOVE BUTTON FIX ---- */
    .btn-remove {
        padding: 6px 14px !important;
        font-size: 14px !important;
        font-weight: 600;
        border-radius: 8px;
        background: #dc3545 !important;
        color: white !important;
        border: none !important;
        display: inline-block;
    }

    /* ---- Add Item ---- */
    #addItem {
        border-radius: 8px;
        padding: 8px 16px;
    }

    /* ---- Save Button (white → blue hover) ---- */
    .btn-save {
        background: white !important;
        color: #0d6efd !important;
        border: 2px solid #0d6efd !important;
        padding: 10px 26px;
        font-size: 17px;
        border-radius: 10px;
        transition: 0.3s ease-in-out;
        font-weight: 600;
    }

        .btn-save:hover {
            background: #0d6efd !important;
            color: white !important;
        }

    /* ---- Cancel Button (white → grey hover) ---- */
    .btn-cancel {
        background: white !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
        padding: 10px 26px;
        font-size: 17px;
        border-radius: 10px;
        transition: 0.3s ease-in-out;
        font-weight: 600;
        margin-left: 10px;
    }

        .btn-cancel:hover {
            background: #6c757d !important;
            color: white !important;
        }
</style>


<div class="container-fluid px-4 py-4">

    <!-- Title + Underline -->
    <h2 class="page-title">@ViewData["Title"]</h2>
    <div class="page-underline"></div>

    <!-- Form -->
    <div class="form-wrapper">

        <form asp-action="CreateOrEdit" method="post">
            <input type="hidden" asp-for="Id" />

            <!-- Date -->
            <div class="mb-4">
                <label asp-for="BazarDate" class="form-label"></label>
                <input asp-for="BazarDate" type="date" class="form-control" />
                <span asp-validation-for="BazarDate" class="text-danger"></span>
            </div>

            <!-- Description -->
            <div class="mb-4">
                <label asp-for="Description" class="form-label"></label>
                <input asp-for="Description" class="form-control" />
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Total -->
            <div class="mb-4">
                <label class="form-label">Total Amount</label>
                <input asp-for="BazarAmount" readonly class="form-control bg-light" />
            </div>

            <!-- Items Title -->
            <h4 class="section-heading">Items</h4>

            <!-- Items Table -->
            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Product Name</th>
                            <th width="120">Quantity</th>
                            <th width="140">Price</th>
                            <th width="120">Total</th>
                            <th width="80">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items != null && Model.Items.Any())
                        {
                            for (int i = 0; i < Model.Items.Count; i++)
                            {
                                <tr>
                                    <td><input asp-for="Items[@i].ProductName" class="form-control" /></td>

                                    <td>
                                        <input asp-for="Items[@i].Quantity"
                                               type="number" step="0.01"
                                               class="form-control quantity" />
                                    </td>

                                    <td>
                                        <input asp-for="Items[@i].Price"
                                               type="number" step="0.01"
                                               class="form-control price" />
                                    </td>

                                    <td>
                                        <span class="item-total">
                                            @(@Model.Items[i].Quantity * @Model.Items[i].Price)
                                        </span>
                                    </td>

                                    <td>
                                        <button type="button" class="btn-remove remove-item">Remove</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Add Item -->
            <button type="button" class="btn btn-outline-primary btn-sm mb-4" id="addItem">
                Add Item
            </button>

            <!-- Save / Cancel -->
            <div class="mt-4">
                <button type="submit" class="btn-save">Save</button>
                <a asp-action="Index" class="btn-cancel">Cancel</a>
            </div>

        </form>

    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        function recalcTotal() {
            let total = 0;

            $('#itemsTable tbody tr').each(function () {
                const qty = parseFloat($(this).find('.quantity').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;

                const itemTotal = qty * price;

                $(this).find('.item-total').text(itemTotal.toFixed(2));
                total += itemTotal;
            });

            $('input[name="BazarAmount"]').val(total.toFixed(2));
        }

        $(document).ready(function () {

            $('#addItem').click(function () {
                const index = $('#itemsTable tbody tr').length;

                const row = `
                    <tr>
                        <td><input name="Items[${index}].ProductName" class="form-control" /></td>
                        <td><input name="Items[${index}].Quantity" type="number" step="0.01" class="form-control quantity" /></td>
                        <td><input name="Items[${index}].Price" type="number" step="0.01" class="form-control price" /></td>
                        <td><span class="item-total">0.00</span></td>
                        <td><button type="button" class="btn-remove remove-item">Remove</button></td>
                    </tr>`;

                $('#itemsTable tbody').append(row);
            });

            $(document).on('click', '.remove-item', function () {
                $(this).closest('tr').remove();
                recalcTotal();
            });

            $(document).on('input', '.quantity, .price', function () {
                recalcTotal();
            });

            recalcTotal();
        });
    </script>
}
