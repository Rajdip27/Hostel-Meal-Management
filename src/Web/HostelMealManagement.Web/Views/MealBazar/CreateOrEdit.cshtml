@model HostelMealManagement.Application.ViewModel.MealBazarVm

@{
    ViewData["Title"] = Model.Id > 0 ? "Edit Meal Bazar" : "Create Meal Bazar";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    body {
        background: #ffffff !important;
        font-family: "Segoe UI", sans-serif;
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 8px;
    }

    .page-underline {
        height: 2px;
        width: 100%;
        background: #cbd5e1;
        opacity: 0.7;
        margin-bottom: 25px;
    }

    .form-wrapper {
        background: rgba(255,255,255,0.8);
        padding: 35px;
        border-radius: 16px;
        border: 1px solid rgba(200,200,200,0.35);
        box-shadow: 0 8px 28px rgba(0,0,0,0.08);
    }

    .form-label {
        font-weight: 600;
        color: #203254;
    }

    .form-control,
    .form-select {
        padding: 12px 14px !important;
        height: 48px;
        border-radius: 10px !important;
        border: 1px solid #b6c1d1;
        background: rgba(255,255,255,0.9);
        font-size: 15px;
    }

    .section-heading {
        margin-top: 35px;
        margin-bottom: 15px;
        font-size: 22px;
        font-weight: 700;
        color: #1e3a8a;
        border-left: 5px solid #3559a8;
        padding-left: 10px;
    }

    #itemsTable thead th {
        background: #3559a8;
        color: white;
        text-align: center;
    }

    .btn-remove {
        background: #dc2626;
        color: white;
        border-radius: 8px;
        padding: 6px 14px;
        border: none;
    }

    .btn-save {
        background: #3559a8 !important;
        color: white !important;
        padding: 12px 28px;
        border-radius: 10px;
        font-size: 17px;
        font-weight: 700;
        border: none;
    }

    .btn-cancel {
        padding: 12px 28px;
        font-size: 17px;
        border-radius: 10px;
        font-weight: 700;
        background: #ffffff;
        color: #6c757d;
        border: 2px solid #6c757d;
        margin-left: 8px;
    }
</style>

<div class="container-fluid px-4 py-4">

    <h2 class="page-title">@ViewData["Title"]</h2>
    <div class="page-underline"></div>

    <div class="form-wrapper">

        <form asp-action="CreateOrEdit" method="post">
            <input type="hidden" asp-for="Id" />

            <!-- ================= BAZAR DATE ================= -->
            <div class="mb-4">
                <label asp-for="BazarDate" class="form-label"></label>
                <input asp-for="BazarDate" type="date" class="form-control" id="BazarDate" />
            </div>

            <!-- ================= START DATE ================= -->
            <div class="mb-4">
                <label asp-for="StartDate" class="form-label"></label>
                <input asp-for="StartDate" type="date" class="form-control bg-light" id="StartDate" readonly />
            </div>

            <!-- ================= END DATE ================= -->
            <div class="mb-4">
                <label asp-for="EndDate" class="form-label"></label>
                <input asp-for="EndDate" type="date" class="form-control" id="EndDate" />
                <small id="dateError" class="text-danger" style="display:none;">
                    End date must be greater than or equal to start date
                </small>
            </div>

            <!-- ================= TOTAL DAYS ================= -->
            <div class="mb-4">
                <label asp-for="TotalDays" class="form-label"></label>
                <input asp-for="TotalDays" class="form-control bg-light" readonly id="TotalDays" />
            </div>

            <!-- ================= MEMBERS ================= -->
            <div class="mb-4">
                <label class="form-label">Member(s)</label>
                <select id="memberSelect" class="form-select" multiple>
                    @foreach (var m in Model.Members)
                    {
                        <option value="@m.Id">@m.Name</option>
                    }
                </select>
                <input type="hidden" asp-for="MealMemberId" id="MealMemberId" />
            </div>

            <!-- ================= ITEMS ================= -->
            <h4 class="section-heading">Bazar Items</h4>

            <table class="table table-bordered" id="itemsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th width="120">Qty</th>
                        <th width="140">Price</th>
                        <th width="140">Total</th>
                        <th width="80">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td><input asp-for="Items[@i].ProductName" class="form-control" /></td>
                            <td><input asp-for="Items[@i].Quantity" class="form-control quantity" /></td>
                            <td><input asp-for="Items[@i].Price" class="form-control price" /></td>
                            <td class="item-total">0.00</td>
                            <td><button type="button" class="btn-remove remove-item">Remove</button></td>
                        </tr>
                    }
                </tbody>
            </table>

            <button type="button" class="btn btn-outline-primary btn-sm mt-3" id="addItem">
                Add Item
            </button>

            <!-- ================= TOTAL AMOUNT ================= -->
            <div class="mb-4 mt-4">
                <label asp-for="BazarAmount" class="form-label"></label>
                <input asp-for="BazarAmount" class="form-control bg-light" readonly id="BazarAmount" />
            </div>

            <!-- ================= ACTIONS ================= -->
            <div class="mt-4">
                <button type="submit" class="btn-save">Save</button>
                <a asp-action="Index" class="btn-cancel">Cancel</a>
            </div>

        </form>
    </div>
</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // ================= DATE LOGIC =================
    function calculateDays() {
        const start = new Date($("#StartDate").val());
        const end = new Date($("#EndDate").val());

        if (end < start) {
            $("#dateError").show();
            $("#TotalDays").val(0);
            return;
        }

        $("#dateError").hide();
        const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        $("#TotalDays").val(days);
    }

    // ================= MEMBER MULTI SELECT =================
    function updateMembers() {
        const ids = $("#memberSelect option:selected")
            .map(function () { return this.value; }).get().join(",");
        $("#MealMemberId").val(ids);
    }

    // ================= ITEM TOTAL =================
    function recalcAmount() {
        let total = 0;

        $("#itemsTable tbody tr").each(function () {
            const qty = parseFloat($(this).find(".quantity").val()) || 0;
            const price = parseFloat($(this).find(".price").val()) || 0;
            const rowTotal = qty * price;
            $(this).find(".item-total").text(rowTotal.toFixed(2));
            total += rowTotal;
        });

        $("#BazarAmount").val(total.toFixed(2));
    }

    // ================= INIT =================
    $(document).ready(function () {

        // ---- Today date (CREATE ONLY) ----
        if (@Model.Id === 0) {
            const today = new Date().toISOString().split("T")[0];
            $("#BazarDate").val(today);
            $("#StartDate").val(today);
        }

        // Sync StartDate with BazarDate
        $("#BazarDate").on("change", function () {
            $("#StartDate").val(this.value);
            calculateDays();
        });

        $("#EndDate").on("change", calculateDays);

        // Preselect members (edit)
        if ($("#MealMemberId").val()) {
            $("#MealMemberId").val().split(",").forEach(id => {
                $(`#memberSelect option[value='${id}']`).prop("selected", true);
            });
        }

        $("#memberSelect").on("change", updateMembers);
        updateMembers();

        $("#addItem").click(function () {
            const index = $("#itemsTable tbody tr").length;
            $("#itemsTable tbody").append(`
                <tr>
                    <td><input name="Items[${index}].ProductName" class="form-control" /></td>
                    <td><input name="Items[${index}].Quantity" class="form-control quantity" /></td>
                    <td><input name="Items[${index}].Price" class="form-control price" /></td>
                    <td class="item-total">0.00</td>
                    <td><button type="button" class="btn-remove remove-item">Remove</button></td>
                </tr>
            `);
        });

        $(document).on("input", ".quantity, .price", recalcAmount);
        $(document).on("click", ".remove-item", function () {
            $(this).closest("tr").remove();
            recalcAmount();
        });

        recalcAmount();
        calculateDays();
    });
</script>
}
